<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Health - NutriAI</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-apple-alt"></i>
                <h1>NutriAI</h1>
            </div>
            <div class="nav-links">
                <a href="../index.html"><i class="fas fa-home"></i> Home</a>
                <a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="nutrition.html"><i class="fas fa-utensils"></i> Nutrition</a>
                <a href="community.html" class="active"><i class="fas fa-users"></i> Community</a>
                <a href="login.html"><i class="fas fa-user"></i> Profile</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <h2>Community Health Surveillance</h2>
        <p class="subtitle">AI-powered population health monitoring and trend analysis</p>
        
        <!-- Community Stats -->
        <div class="chart-container">
            <h3>Community Health Overview</h3>
            <div id="community-stats">
                <!-- Dynamically loaded -->
            </div>
        </div>
        
        <!-- Health Map -->
        <div class="chart-container">
            <h3>Regional Health Distribution</h3>
            <div id="health-map" style="height: 400px; border-radius: 8px; overflow: hidden;"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #2ecc71;"></span>
                    <span>Low Risk (BMI < 25)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #f39c12;"></span>
                    <span>Medium Risk (BMI 25-30)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #e74c3c;"></span>
                    <span>High Risk (BMI > 30)</span>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="riskChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="regionalChart"></canvas>
            </div>
        </div>
        
        <!-- Health Trends -->
        <div class="chart-container">
            <h3>Health Trends Over Time</h3>
            <div class="trends-container">
                <div class="trend-chart">
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="trend-stats">
                    <h4>Key Observations</h4>
                    <div class="trend-item positive">
                        <i class="fas fa-arrow-down"></i>
                        <div>
                            <strong>Obesity Rate: -2.3%</strong>
                            <p>Decreased over last 6 months</p>
                        </div>
                    </div>
                    <div class="trend-item positive">
                        <i class="fas fa-arrow-up"></i>
                        <div>
                            <strong>Healthy Eating: +15%</strong>
                            <p>More users meeting nutrition targets</p>
                        </div>
                    </div>
                    <div class="trend-item negative">
                        <i class="fas fa-arrow-up"></i>
                        <div>
                            <strong>Screen Time: +8%</strong>
                            <p>Increased sedentary behavior</p>
                        </div>
                    </div>
                    <div class="trend-item positive">
                        <i class="fas fa-arrow-down"></i>
                        <div>
                            <strong>Fast Food: -12%</strong>
                            <p>Reduced consumption frequency</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Risk Factors Analysis -->
        <div class="chart-container">
            <h3>Common Risk Factors Analysis</h3>
            <div class="risk-factors">
                <div class="risk-factor">
                    <h4>Dietary Issues</h4>
                    <div class="risk-meter">
                        <div class="risk-level" style="width: 65%"></div>
                    </div>
                    <p>65% of users exceed recommended sugar intake</p>
                </div>
                <div class="risk-factor">
                    <h4>Physical Activity</h4>
                    <div class="risk-meter">
                        <div class="risk-level" style="width: 40%"></div>
                    </div>
                    <p>40% don't meet minimum exercise requirements</p>
                </div>
                <div class="risk-factor">
                    <h4>Sleep Patterns</h4>
                    <div class="risk-meter">
                        <div class="risk-level" style="width: 55%"></div>
                    </div>
                    <p>55% get less than 7 hours of sleep nightly</p>
                </div>
                <div class="risk-factor">
                    <h4>Stress Levels</h4>
                    <div class="risk-meter">
                        <div class="risk-level" style="width: 70%"></div>
                    </div>
                    <p>70% report high stress affecting eating habits</p>
                </div>
            </div>
        </div>
        
        <!-- Public Health Recommendations -->
        <div class="chart-container">
            <h3>AI-Generated Public Health Recommendations</h3>
            <div class="recommendations-list">
                <div class="recommendation priority-high">
                    <div class="recommendation-header">
                        <span class="priority-badge">High Priority</span>
                        <h4>Nutrition Education Campaign</h4>
                    </div>
                    <p>Implement community nutrition workshops focusing on sugar reduction and portion control. Target areas with obesity rates above 30%.</p>
                    <div class="recommendation-metrics">
                        <span><i class="fas fa-users"></i> Estimated Impact: 500+ individuals</span>
                        <span><i class="fas fa-clock"></i> Timeline: 3 months</span>
                    </div>
                </div>
                
                <div class="recommendation priority-medium">
                    <div class="recommendation-header">
                        <span class="priority-badge">Medium Priority</span>
                        <h4>Active Lifestyle Promotion</h4>
                    </div>
                    <p>Create community walking groups and partner with local gyms for discounted memberships. Focus on sedentary population segments.</p>
                    <div class="recommendation-metrics">
                        <span><i class="fas fa-users"></i> Estimated Impact: 300+ individuals</span>
                        <span><i class="fas fa-clock"></i> Timeline: 6 months</span>
                    </div>
                </div>
                
                <div class="recommendation priority-low">
                    <div class="recommendation-header">
                        <span class="priority-badge">Low Priority</span>
                        <h4>Sleep Hygiene Awareness</h4>
                    </div>
                    <p>Distribute educational materials on sleep importance and create digital reminders for consistent sleep schedules.</p>
                    <div class="recommendation-metrics">
                        <span><i class="fas fa-users"></i> Estimated Impact: 1000+ individuals</span>
                        <span><i class="fas fa-clock"></i> Timeline: Ongoing</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Research Data Export -->
        <div class="chart-container">
            <h3>Research Data & Export</h3>
            <div class="data-export">
                <p>Anonymized community health data available for research purposes:</p>
                <div class="export-options">
                    <button onclick="exportData('csv')" class="btn-secondary">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button onclick="exportData('json')" class="btn-secondary">
                        <i class="fas fa-file-code"></i> Export JSON
                    </button>
                    <button onclick="exportData('report')" class="btn-secondary">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>
                <div class="data-summary">
                    <h4>Data Summary</h4>
                    <ul>
                        <li>Total Users: 1,500</li>
                        <li>Data Collection Period: 6 months</li>
                        <li>Average Daily Logs: 2,100</li>
                        <li>Regional Coverage: 4 regions</li>
                        <li>Data Completeness: 92%</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Ethical Considerations -->
        <div class="chart-container ethical-section">
            <h3><i class="fas fa-shield-alt"></i> Ethical Considerations</h3>
            <div class="ethical-points">
                <div class="ethical-point">
                    <i class="fas fa-user-shield"></i>
                    <div>
                        <h4>Data Privacy</h4>
                        <p>All data is anonymized and aggregated. No personally identifiable information is stored.</p>
                    </div>
                </div>
                <div class="ethical-point">
                    <i class="fas fa-clipboard-check"></i>
                    <div>
                        <h4>Informed Consent</h4>
                        <p>All participants provided informed consent for data collection and research use.</p>
                    </div>
                </div>
                <div class="ethical-point">
                    <i class="fas fa-balance-scale"></i>
                    <div>
                        <h4>IRB Approval</h4>
                        <p>Research protocol approved by Institutional Review Board (IRB-2024-045).</p>
                    </div>
                </div>
                <div class="ethical-point">
                    <i class="fas fa-lock"></i>
                    <div>
                        <h4>Data Security</h4>
                        <p>Encrypted data storage with access limited to authorized researchers.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize map
        function initMap() {
            // Create a simple map
            const map = L.map('health-map').setView([51.505, -0.09], 13);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            // Add markers for different regions
            const regions = [
                { name: 'North District', lat: 51.51, lng: -0.08, obesityRate: 32.5, color: '#e74c3c' },
                { name: 'South District', lat: 51.50, lng: -0.09, obesityRate: 28.2, color: '#f39c12' },
                { name: 'East District', lat: 51.505, lng: -0.07, obesityRate: 25.7, color: '#2ecc71' },
                { name: 'West District', lat: 51.505, lng: -0.11, obesityRate: 30.1, color: '#f39c12' }
            ];
            
            regions.forEach(region => {
                const marker = L.circleMarker([region.lat, region.lng], {
                    color: region.color,
                    fillColor: region.color,
                    fillOpacity: 0.7,
                    radius: 20
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${region.name}</strong><br>
                    Obesity Rate: ${region.obesityRate}%<br>
                    Population: ~375,000<br>
                    Health Score: ${Math.round(100 - region.obesityRate)}/100
                `);
            });
            
            // Add legend control
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.innerHTML = `
                    <h4>Obesity Rate</h4>
                    <div><span style="background:#2ecc71"></span> < 25%</div>
                    <div><span style="background:#f39c12"></span> 25-30%</div>
                    <div><span style="background:#e74c3c"></span> > 30%</div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        // Create trend chart
        function createTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            const trendData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [
                    {
                        label: 'Obesity Rate (%)',
                        data: [32.5, 31.8, 30.9, 30.2, 29.5, 29.0, 28.5],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Healthy Eating Score',
                        data: [65, 68, 70, 72, 75, 77, 80],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: trendData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Community Health Trends (Last 7 Months)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 20,
                            max: 85
                        }
                    }
                }
            });
        }
        
        // Export data function
        function exportData(format) {
            const formats = {
                csv: 'Comma Separated Values',
                json: 'JSON Data',
                report: 'PDF Report'
            };
            
            alert(`Downloading ${formats[format]} file...\n\nThis would generate and download the requested data file in a real implementation.`);
            
            // In a real implementation, this would make an API call
            // to generate and download the file
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            initMap();
            
            // Create charts
            createTrendChart();
            
            // Load community stats
            loadCommunityData();
            
            // Add CSS for this page
            const style = document.createElement('style');
            style.textContent = `
                .subtitle {
                    color: #666;
                    margin-bottom: 30px;
                    font-size: 1.1em;
                }
                
                .charts-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin: 20px 0;
                }
                
                .map-legend {
                    display: flex;
                    gap: 20px;
                    margin-top: 15px;
                    justify-content: center;
                }
                
                .legend-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .legend-color {
                    width: 20px;
                    height: 20px;
                    border-radius: 4px;
                }
                
                .trends-container {
                    display: grid;
                    grid-template-columns: 2fr 1fr;
                    gap: 30px;
                }
                
                .trend-stats {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }
                
                .trend-item {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    padding: 15px;
                    border-radius: 8px;
                    background: #f8f9fa;
                }
                
                .trend-item.positive {
                    border-left: 4px solid #2ecc71;
                }
                
                .trend-item.negative {
                    border-left: 4px solid #e74c3c;
                }
                
                .trend-item i {
                    font-size: 1.5em;
                }
                
                .trend-item.positive i {
                    color: #2ecc71;
                }
                
                .trend-item.negative i {
                    color: #e74c3c;
                }
                
                .risk-factors {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                    margin: 20px 0;
                }
                
                .risk-factor {
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                }
                
                .risk-meter {
                    height: 8px;
                    background: #eee;
                    border-radius: 4px;
                    margin: 15px 0;
                    overflow: hidden;
                }
                
                .risk-level {
                    height: 100%;
                    background: linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c);
                    border-radius: 4px;
                }
                
                .recommendations-list {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                    margin: 20px 0;
                }
                
                .recommendation {
                    padding: 20px;
                    border-radius: 8px;
                    border-left: 4px solid #ddd;
                }
                
                .recommendation.priority-high {
                    border-left-color: #e74c3c;
                    background: rgba(231, 76, 60, 0.05);
                }
                
                .recommendation.priority-medium {
                    border-left-color: #f39c12;
                    background: rgba(243, 156, 18, 0.05);
                }
                
                .recommendation.priority-low {
                    border-left-color: #3498db;
                    background: rgba(52, 152, 219, 0.05);
                }
                
                .recommendation-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                }
                
                .priority-badge {
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.85em;
                    font-weight: 600;
                }
                
                .priority-high .priority-badge {
                    background: #e74c3c;
                    color: white;
                }
                
                .priority-medium .priority-badge {
                    background: #f39c12;
                    color: white;
                }
                
                .priority-low .priority-badge {
                    background: #3498db;
                    color: white;
                }
                
                .recommendation-metrics {
                    display: flex;
                    gap: 20px;
                    margin-top: 15px;
                    color: #666;
                    font-size: 0.9em;
                }
                
                .recommendation-metrics i {
                    margin-right: 5px;
                }
                
                .data-export {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                }
                
                .export-options {
                    display: flex;
                    gap: 10px;
                    margin: 20px 0;
                }
                
                .data-summary ul {
                    columns: 2;
                    column-gap: 40px;
                    margin: 20px 0;
                    padding-left: 20px;
                }
                
                .data-summary li {
                    margin: 10px 0;
                }
                
                .ethical-section {
                    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
                    color: white;
                }
                
                .ethical-section h3 {
                    color: white;
                }
                
                .ethical-points {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                    margin: 20px 0;
                }
                
                .ethical-point {
                    display: flex;
                    gap: 15px;
                    align-items: flex-start;
                }
                
                .ethical-point i {
                    font-size: 1.5em;
                    color: #2ecc71;
                    margin-top: 5px;
                }
                
                .ethical-point h4 {
                    margin-bottom: 5px;
                    color: #2ecc71;
                }
                
                .ethical-point p {
                    color: rgba(255,255,255,0.8);
                    font-size: 0.9em;
                }
                
                @media (max-width: 768px) {
                    .charts-grid,
                    .trends-container {
                        grid-template-columns: 1fr;
                    }
                    
                    .data-summary ul {
                        columns: 1;
                    }
                    
                    .export-options {
                        flex-direction: column;
                    }
                }
            `;
            document.head.appendChild(style);
        });
        
        // Load community data
        async function loadCommunityData() {
            try {
                const response = await fetch('http://localhost:5000/api/community-health');
                const data = await response.json();
                displayCommunityStats(data);
                createCommunityCharts(data);
            } catch (error) {
                console.error('Error loading community data:', error);
                displayMockCommunityData();
            }
        }
        
        function displayCommunityStats(data) {
            const container = document.getElementById('community-stats');
            if (!container) return;
            
            const stats = data.community_analysis?.community_stats || {
                sample_size: 1500,
                avg_bmi: 25.8,
                obesity_rate: 28.5,
                health_risk_distribution: {
                    low_risk: 60,
                    medium_risk: 30,
                    high_risk: 10
                }
            };
            
            container.innerHTML = `
                <div class="community-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3>${stats.sample_size}</h3>
                        <p>Users in Community</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-weight"></i>
                        <h3>${stats.avg_bmi}</h3>
                        <p>Average BMI</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <h3>${stats.obesity_rate}%</h3>
                        <p>Obesity Rate</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-heartbeat"></i>
                        <h3>${stats.health_risk_distribution.low_risk}%</h3>
                        <p>Low Risk Users</p>
                    </div>
                </div>
            `;
        }
        
        function createCommunityCharts(data) {
            // Risk distribution chart
            const riskCtx = document.getElementById('riskChart');
            if (riskCtx) {
                const riskData = data.community_analysis?.community_stats?.health_risk_distribution || {
                    low_risk: 60,
                    medium_risk: 30,
                    high_risk: 10
                };
                
                new Chart(riskCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                        datasets: [{
                            data: [riskData.low_risk, riskData.medium_risk, riskData.high_risk],
                            backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Community Health Risk Distribution'
                            }
                        }
                    }
                });
            }
            
            // Regional data chart
            const regionalCtx = document.getElementById('regionalChart');
            if (regionalCtx) {
                const regions = data.regional_data ? Object.keys(data.regional_data) : ['North', 'South', 'East', 'West'];
                const obesityRates = regions.map(region => 
                    data.regional_data?.[region]?.obesity_rate || 
                    (region === 'North' ? 32.5 : 
                     region === 'South' ? 28.2 : 
                     region === 'East' ? 25.7 : 30.1)
                );
                
                new Chart(regionalCtx, {
                    type: 'bar',
                    data: {
                        labels: regions,
                        datasets: [{
                            label: 'Obesity Rate (%)',
                            data: obesityRates,
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Obesity Rates by Region'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 40
                            }
                        }
                    }
                });
            }
        }
        
        function displayMockCommunityData() {
            const mockData = {
                community_analysis: {
                    community_stats: {
                        sample_size: 1500,
                        avg_bmi: 25.8,
                        obesity_rate: 28.5,
                        health_risk_distribution: {
                            low_risk: 60,
                            medium_risk: 30,
                            high_risk: 10
                        }
                    }
                },
                regional_data: {
                    'North': { obesity_rate: 32.5 },
                    'South': { obesity_rate: 28.2 },
                    'East': { obesity_rate: 25.7 },
                    'West': { obesity_rate: 30.1 }
                }
            };
            
            displayCommunityStats(mockData);
            createCommunityCharts(mockData);
        }
    </script>
</body>
</html>